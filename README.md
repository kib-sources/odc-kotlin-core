# Open Digital Cash -- Kotlin Core

(Russian)

## Передача банк -> клиент


![Alt text](./doc/diagram_1.png)

Обмен следующий.

---

**Шаг 1**
Банк-эмитент создаёт новую банкноту:
```kotlin
    val banknote = bankIssuer.newBanknote(
            amount = amount,
            bin = BIN,
            currencyCode=ISO_4217_CODE.RUB,
    )
```

После эта банкнота передаётся Алисе.

---

**Шаг 2**
Алиса верифицирует корректность банкноты
```kotlin
    if ( ! banknote.verification(bok)){
        throw Exception("Банкнота поддельная")
    }
```
---
**Шаг 3**
Алиса генерирует ***часть** первого блока блокчейна.

(!) *На **каждую** банкноту генерируется свой блокчейн*

```kotlin
var (block, protectedBlock) = walletA.firstBlock(banknote)
```

`protectedBlock` -- это защищённый блок блокчейна. 
Данный блок передаётся только между двумя парами передающих сторон
а так же при операции **push** на сервер.

Таким образом имея весь блокчейн мы не можем сказать кто был участником, 
кроме последнего блока (что логично.)

После Алиса передаёт `block` и `protectedBlock` банку-эмитенту

---

**Шаг 4**

Банк подписывает первый блок блокчейна:
```kotlin
block = bankIssuer.signature(banknote, block, protectedBlock)
```

Этот блок передаётся Алисе. 
Банк некоторое время ждёт (**Шаг 5а**), на случай если пакет пропадёт.

---

**Шаг 5b.**

Алиса перепроверяет что блок `block` корректно записан

---

**Шаг 6 (а,b)** -- запись в локальный блокчейн и в глобальный блокчейн

## Передача клиент -> клиент

Передача между двумя клиентами может происходить как offline, так и online.

[//]:  https://programforyou.ru/block-diagram-redactor

![Alt text](./doc/diagram_2.png)

TODO описание